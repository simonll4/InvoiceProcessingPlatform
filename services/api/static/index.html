<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR-LLM Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragging {
            border-color: #764ba2;
            background: #e8eaff;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            margin-top: 30px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 1.5em;
            color: #333;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .json-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .json-key {
            color: #9cdcfe;
        }

        .json-string {
            color: #ce9178;
        }

        .json-number {
            color: #b5cea8;
        }

        .json-boolean {
            color: #569cd6;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .warnings {
            background: #fff8e1;
            border-left: 4px solid #f59e0b;
            color: #854d0e;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0 20px 0;
            display: none;
        }

        .warnings ul {
            margin: 10px 0 0 20px;
        }

        .success-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“„ OCR-LLM Pipeline</h1>
        <p class="subtitle">Extrae datos de facturas y recibos automÃ¡ticamente</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“¤</div>
            <div class="upload-text">Arrastra un archivo aquÃ­ o haz clic para seleccionar</div>
            <div class="upload-hint">Soporta: PDF, JPG, PNG, BMP (mÃ¡x 10MB)</div>
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.bmp">
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Procesando documento...</p>
            <p style="color: #999; font-size: 0.9em;">Esto puede tomar 10-30 segundos</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result" id="result">
            <div class="result-header">
                <h2 class="result-title">âœ… Resultado</h2>
                <button class="btn" onclick="reset()">Nuevo Documento</button>
            </div>

            <div class="warnings" id="warnings"></div>

            <div class="info-grid" id="infoGrid"></div>

            <h3 style="margin: 20px 0 10px; color: #333;">JSON Completo:</h3>
            <pre class="json-viewer" id="jsonViewer"></pre>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const error = document.getElementById('error');
        const jsonViewer = document.getElementById('jsonViewer');
        const infoGrid = document.getElementById('infoGrid');
        const warningsBox = document.getElementById('warnings');

        // Click para abrir selector
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        // SelecciÃ³n de archivo
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        async function handleFile(file) {
            // Validar tamaÃ±o
            if (file.size > 10 * 1024 * 1024) {
                showError('El archivo es demasiado grande. MÃ¡ximo 10MB.');
                return;
            }

            // Validar tipo
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/bmp'];
            if (!validTypes.includes(file.type)) {
                showError('Tipo de archivo no soportado. Use PDF, JPG, PNG o BMP.');
                return;
            }

            // Preparar UI
            uploadArea.style.display = 'none';
            loading.style.display = 'block';
            error.style.display = 'none';
            result.style.display = 'none';

            // Enviar a API
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/extract`, {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type') || '';
                if (!response.ok) {
                    // Intentar leer JSON de error; si no, leer texto
                    if (contentType.includes('application/json')) {
                        const errJson = await response.json().catch(() => ({}));
                        throw new Error(errJson.detail || `Error ${response.status}: no se pudo procesar el documento`);
                    } else {
                        const errText = await response.text().catch(() => '');
                        if (response.status === 504) {
                            throw new Error('La solicitud tardÃ³ demasiado (504). Es normal en la primera ejecuciÃ³n mientras se descarga el modelo OCR. Reintenta en 1-2 minutos.');
                        }
                        const excerpt = (errText || '').slice(0, 140).replace(/\s+/g, ' ').trim();
                        throw new Error(`Error ${response.status}: ${excerpt || 'Respuesta no vÃ¡lida de la API'}`);
                    }
                }

                // Solo parsear JSON si ok y content-type JSON
                if (!contentType.includes('application/json')) {
                    const text = await response.text().catch(() => '');
                    throw new Error(`Respuesta inesperada de la API (no JSON). CÃ³digo ${response.status}.`);
                }
                const data = await response.json();

                // Mostrar resultado
                showResult(data.data);

            } catch (err) {
                showError(err.message);
                uploadArea.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function showResult(payload) {
            result.style.display = 'block';

            const invoice = payload.invoice || {};
            const items = Array.isArray(payload.items) ? payload.items : [];
            const notes = payload && payload.notes ? payload.notes : null;
            const warnings = Array.isArray(notes && notes.warnings) ? notes.warnings.filter(Boolean) : [];
            const currency = invoice.currency_code || '';

            const formatMoney = (value) => {
                if (value === undefined || value === null) {
                    return null;
                }
                const numeric = Number(value);
                if (!Number.isFinite(numeric)) {
                    return null;
                }
                const formatted = (numeric / 100).toFixed(2);
                return currency ? `${currency} ${formatted}` : formatted;
            };

            const cards = [];
            const pushCard = (label, value) => {
                cards.push(`
                    <div class="info-card">
                        <div class="info-label">${label}</div>
                        <div class="info-value">${value}</div>
                    </div>
                `);
            };

            if (invoice.vendor_name) pushCard('Proveedor', invoice.vendor_name);
            if (invoice.invoice_date) pushCard('Fecha de factura', invoice.invoice_date);
            if (invoice.invoice_number) pushCard('NÃºmero', invoice.invoice_number);
            if (currency) pushCard('Moneda', currency);

            const total = formatMoney(invoice.total_cents);
            if (total) pushCard('Total', total);

            const subtotal = formatMoney(invoice.subtotal_cents);
            if (subtotal) pushCard('Subtotal', subtotal);

            const tax = formatMoney(invoice.tax_cents);
            if (tax) pushCard('Impuestos', tax);

            if (items.length) pushCard('Items detectados', `${items.length} productos`);

            infoGrid.innerHTML = cards.length
                ? cards.join('')
                : `
                    <div class="info-card">
                        <div class="info-label">Sin metadatos</div>
                        <div class="info-value">Revisa el JSON completo abajo</div>
                    </div>
                `;

            if (warnings.length) {
                warningsBox.innerHTML = `
                    <strong>Notas del pipeline</strong>
                    <ul>
                        ${warnings.map((warning) => `<li>${warning}</li>`).join('')}
                    </ul>
                `;
                warningsBox.style.display = 'block';
            } else {
                warningsBox.style.display = 'none';
                warningsBox.innerHTML = '';
            }

            jsonViewer.textContent = JSON.stringify(payload, null, 2);
        }

        function showError(message) {
            error.textContent = 'âŒ ' + message;
            error.style.display = 'block';
            warningsBox.style.display = 'none';
            warningsBox.innerHTML = '';
        }

        function reset() {
            uploadArea.style.display = 'block';
            result.style.display = 'none';
            error.style.display = 'none';
            fileInput.value = '';
            warningsBox.style.display = 'none';
            warningsBox.innerHTML = '';
        }

        // Warmup OCR on page load (non-blocking)
        window.addEventListener('load', async () => {
            try {
                await fetch(`${API_URL}/warmup`, { method: 'GET' });
            } catch (_) {
                // Ignorar errores de warmup
            }
        });
    </script>
</body>
</html>
